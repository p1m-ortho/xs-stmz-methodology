# METHOD.md

## Текущая задача

### Актуальность

См. в других разделах этого файла.

### Цель

Оценить корректность подсчета поступивших за период с 30.01.2019 по 05.02.2019.

Основная гипотеза: (а) запрос выдает меньше поступивших за этот период (с 30.01.2019 по 05.02.2019), чем выявлено при поиске вручную, и (б) причина этого — в том, что не было за этот период спинальных операций у этих пациентов _и_ спинальные КТ или МРТ, которые были сделаны, в Ариадне на момент выполнения запроса еще не описаны.

### Планирование: методы

* Поднять электронные истории всех поступивших через приемное или АКО с 30.01.2019 00:00 по 04.02.2019 23:59.
* Извлечь списки в файлы.
* Перенести из этих файлов в [CSV-экспорт из созданной в FormTools формы](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/29694bfe9ebbec62ee7288ea3b6118f09ba07bec/ft_form_7.csv).
* Выполнить запрос по дате поступления с 30.01.2019 по 04.02.2019 и извлечь поступивших и их типы спинальности в файл.
* Заполнить на основании этого файла поля формы, касающиеся запроса.
* Загрузить этот файл в базу данных FormTools.
* Провести процедуру анонимизации (см. приложение) и загрузить этот файл сюда, обновив файл `ft_form_7.csv`.
* Участники из личных аккаунтов получат доступ к веб-интерфейсу формы и дозаполнят недостающие поля: будут вручную открывать каждую историю и оценивать ее «тип спинальности» в соответствии с ранее разработанным алгоритмом (см. приложение).
* При этом в форме все вопросы имеют закрытый характер и имеют опцию «не выбрано» (вид формы см. ниже в разделе о планировании результатов), а также в форме нельзя добавить или удалить запись — можно только просмотреть все списком либо переключить на предыдущую или следующую.
* Ручной просмотр историй и сопоставление по критериям с заполнением таблиц будем выполнять независимо двумя людьми.
* По завершении заполнения — анонимизировать (см. приложение) и экспортировать сюда в виде файлов `ft_form_7.csv`.
* Отвергнуть или принять основную гипотезу.
* Рассчитать показатели согласия между участниками в плане определения типа.
* Вынести заключение о корректности или некорректности определения типа запросом в соответствии с алгоритмом (на данной выборке будет не сделать, т. к. мало будет результатов в выдаче запроса).

### Планирование: результаты

Создал форму в [FormTools](https://formtools.org) в режиме внутреннего пользования. Структуру формы см. [экспорте формы в CSV](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/29694bfe9ebbec62ee7288ea3b6118f09ba07bec/ft_form_7.csv) (пробную строчку, правда, забыл убрать).

Типы редактируемых полей (SELECT из БД FormTools):

```
data_type,field_title,col_name
string,Путь поступления,admission_mode
string,Дата и время поступления,admission_timestamp
number,UPI (компьютерный номер),upi
number,MRN (номер истории),mrn
string,Наличие в результатах запроса,is_retrieved_by_query
string,Тип спинальности по запросу,spinality_type_per_query
string,Тип спинальности вручную,spinality_type_manual
string,Примечание,comment
```

Копипаста формы из FormTools выглядит таким образом:

```
Путь поступления	 Не выбрано   AKO   ПО
Дата и время поступления	
UPI (компьютерный номер)	
MRN (номер истории)	
Тип спинальности вручную	 Не выбрано 
 Спинальная операция 
 Спинальная КТ или МРТ 
 Спинальный осмотр 
 Спинальный диагноз поступления 
 Не спинальный диагноз поступления 
Наличие в результатах запроса	 Не выбрано   Да   Нет
Тип спинальности по запросу	 Не выбрано 
 Спинальная операция 
 Спинальная КТ или МРТ 
 Спинальный осмотр 
 Спинальный диагноз поступления 
 Не спинальный диагноз поступления
```

### Приложение. Алгоритм определения типа спинальности

* Если за время госпитализации выполнялась хотя бы одна хирургическая операция, то если хотя бы одна из этих операций по коду соответствует одному из кодов, перечисленных в ТЗ (список внутренних кодов, применяемых в НИИ СП для кодирования спинальных операций; загрузим позднее), то включить в выборку (назовем этот критерий "Спинальная операция").
* Если ни одной операции не было, но выполнялась хотя бы одна МРТ или КТ, то если в описании хотя бы одной из этих КТ или МРТ есть совпадение по маске "позвон", то включить в выборку ("Спинальная КТ или МРТ").
* Если ни одной КТ и МРТ не выполнялось, то если был хотя бы один осмотр травматолога или нейрохирурга, то если в поле "Заключение" хотя бы одного из этих осмотров есть совпадение по регулярному выражению (см. приложение), то включить в выборку ("Спинальный осмотр").
* Если не было ни одного осмотра травматолога и нейрохирурга, то если в поле "Диагноз поступления" в "Протоколе регистратора" есть совпадение по регулярному выражению (см. приложение), то включить в выборку ("Спинальный диагноз поступления").

### Приложение. Регулярное выражение — критерий для типов «Спинальный осмотр» и «Спинальный диагноз поступления»

```
"/(позвон|спондил|спин|вертебр|шейн|грудн|поясни|шоп|гоп|поп|пкоп|([thтнcсlл]{1,2} ?\d{1,2})|псмт|ддз|хондро|грыж.*диск|радикул|кореш|каудопати|конск.*хвост|плеги|парез|паретическ|тазов.*орган)/i"
```

### Приложение. Процедура анонимизации

Оставить только значения полей ниже, которые расцениваю как не содержащие идентифицирующую личность пациента информацию:

```
submission_id
is_retrieved_by_query
spinality_type_per_query
spinality_type_manual
submission_date
last_modified_date
is_finalized
```

Значения всех остальных полей заменить на `*****`.

## Ручной контроль обновлений по запросу

Добавлена возможность поиска записей по дате поступления, и возможность отбора записей по типу спинальности. Добавлены критерии поиска по спинальному диагнозу, по спинальному осмотру. 

~~Запрос перестал работать: форма открывается, но всегда выдает ноль записей.~~ На поверку сейчас оказалось неправдой и почти наверняка было неправдой и тогда.

Проблема, похоже, в другом: у поступивших за этот период (с 30.01.2019 по 05.02.2019) не было за этот период операций _и_ снимки, которые были сделаны, в Ариадне еще не описаны.

Сейчас попробуем проверить эту гипотезу (посмотреть электронные истории известных пациентов, поступивших за это время), и если это действительно так, то это еще одно мощнейшее обоснование для двух оставшихся (до сих пор не доработанных) критериев включения («типов спинальности»): по тексту осмотров нейрохирургов и травматологов и диагнозу поступления.

## Связь с компьютерным отделом и службой поддержки

PL/SQL-щики сообщают, что в работе. 

## История развития событий

Историю развития событий загрузим позднее.
