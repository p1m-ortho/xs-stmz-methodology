# METHOD.md

## Текущая задача

### Актуальность

См. в других разделах этого файла.

### Цель

Оценить корректность подсчета поступивших за период с 30.01.2019 по 05.02.2019.

Основная гипотеза: (а) запрос выдает меньше поступивших за этот период (с 30.01.2019 по 05.02.2019), чем выявлено при поиске вручную, и (б) причина этого — в том, что не было за этот период спинальных операций у этих пациентов _и_ спинальные КТ или МРТ, которые были сделаны, в Ариадне на момент выполнения запроса еще не описаны.

### Планирование: методы

* Поднять электронные истории всех поступивших через приемное или АКО с 30.01.2019 00:00 по 04.02.2019 23:59.
* Извлечь списки в файлы.
* Перенести из этих файлов в [CSV-экспорт из созданной в FormTools формы](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/340a619cecc202ed2b207073d1ab1f39a1551da2/ft_form_7.csv).
* Выполнить запрос по дате поступления с 30.01.2019 по 04.02.2019 и извлечь поступивших и их типы спинальности в файл.
* Заполнить на основании этого файла поля формы, касающиеся запроса.
* Загрузить этот файл в базу данных FormTools.
* Провести процедуру анонимизации (см. [приложение по анонимизации](#приложение-процедура-анонимизации)) и загрузить этот файл сюда, обновив файл [ft_form_7.csv](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/master/ft_form_7.csv).
* Участники из личных аккаунтов получат доступ к веб-интерфейсу формы и дозаполнят недостающие поля: будут вручную открывать каждую историю и оценивать ее «тип спинальности» в соответствии с ранее разработанным алгоритмом (см. [приложение по алгоритму](#приложение-алгоритм-определения-типа-спинальности)).
* При этом в форме все вопросы имеют закрытый характер и имеют опцию «не выбрано» (вид формы см. ниже в разделе о планировании результатов), а также в форме нельзя добавить или удалить запись — можно только просмотреть все списком либо переключить на предыдущую или следующую.
* Ручной просмотр историй и сопоставление по критериям с заполнением таблиц будем выполнять независимо двумя людьми.
* По завершении заполнения — анонимизировать (см. [приложение по анонимизации](#приложение-процедура-анонимизации)) и экспортировать сюда, обновив файл [ft_form_7.csv](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/master/ft_form_7.csv).
* Отвергнуть или принять основную гипотезу.
* Рассчитать показатели согласия между участниками в плане определения типа.
* Вынести заключение о корректности или некорректности определения типа запросом в соответствии с алгоритмом (на данной выборке будет не сделать, т. к. мало будет результатов в выдаче запроса).

### Планирование: результаты

Создал форму в [FormTools](https://formtools.org) в режиме внутреннего пользования (т. е. форма доступна только из личного аккаунта участника).

Копипаста формы для каждого из заполняющих выглядит таким образом, при этом редактируемы только поля «Тип спинальности вручную» (можно выбрать тип, используя переключатель) и «Примечание» (до 2000 символов):

```
Путь поступления	
Дата и время поступления	
UPI (компьютерный номер)	
MRN (номер истории)	
Тип спинальности вручную	 Не выбрано 
 Спинальная операция 
 Спинальная КТ или МРТ 
 Спинальный осмотр 
 Спинальный диагноз поступления 
 Не спинальный диагноз поступления 
Примечание	
```

Сама FormTools хранит данные в отдельной таблице БД.

Всего в ней 15 полей (см. [экспорт из FormTools](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/340a619cecc202ed2b207073d1ab1f39a1551da2/ft_form_7.csv); здесь и ниже CSV получены путем SQL SELECT из БД FormTools):

Из них 1 поле (`is_finalized`) — служебное, содержит значение `yes`, если форма подана, или `no`, если форма начата и заполнена, но еще не подана.

4 поля заполняются программой автоматически при подаче и изменении записи и содержат ее характеристики («Свидание» — кривой перевод для «Подано»):

```
data_type,field_title,col_name
number,ID,submission_id
date,Свидание,submission_date
date,Изменен,last_modified_date
number,IP-адрес,ip_address
```

4 поля заполним путем перенесения данных из списков поступивших:

```
data_type,field_title,col_name
string,Путь поступления,admission_mode
string,Дата и время поступления,admission_timestamp
string,UPI (компьютерный номер),upi
string,MRN (номер истории),mrn
```

2 поля заполним путем перенесения данных из результатов запроса:

```
data_type,field_title,col_name
string,Наличие в результатах запроса,is_retrieved_by_query
string,Тип спинальности по запросу,spinality_type_per_query
```

2 поля заполнит вручную один заполняющий:

```
data_type,field_title,col_name
string,Тип спинальности вручную,spinality_type_manual_1
string,Примечание,comment_1
```

2 поля заполнит вручную второй заполняющий:

```
data_type,field_title,col_name
string,Тип спинальности вручную,spinality_type_manual_2
string,Примечание,comment_2
```

Итого 15 полей.

### Приложение. Алгоритм определения типа спинальности

* Если за время госпитализации выполнялась хотя бы одна хирургическая операция, то если хотя бы одна из этих операций по коду соответствует одному из кодов, перечисленных в ТЗ (список внутренних кодов, применяемых в НИИ СП для кодирования спинальных операций; загрузим позднее), то включить в выборку (назовем этот критерий "Спинальная операция").
* Если ни одной операции не было, но выполнялась хотя бы одна МРТ или КТ, то если в описании хотя бы одной из этих КТ или МРТ есть совпадение по маске "позвон", то включить в выборку ("Спинальная КТ или МРТ").
* Если ни одной КТ и МРТ не выполнялось, то если был хотя бы один осмотр травматолога или нейрохирурга, то если в поле "Заключение" хотя бы одного из этих осмотров есть совпадение по регулярному выражению (см. [приложение по регулярному выражению](#приложение-регулярное-выражение--критерий-для-типов-спинальный-осмотр-и-спинальный-диагноз-поступления)), то включить в выборку ("Спинальный осмотр").
* Если не было ни одного осмотра травматолога и нейрохирурга, то если в поле "Диагноз поступления" в "Протоколе регистратора" есть совпадение по регулярному выражению (см. [приложение по регулярному выражению](#приложение-регулярное-выражение--критерий-для-типов-спинальный-осмотр-и-спинальный-диагноз-поступления)), то включить в выборку ("Спинальный диагноз поступления").

### Приложение. Регулярное выражение — критерий для типов «Спинальный осмотр» и «Спинальный диагноз поступления»

```
"/(позвон|спондил|спин|вертебр|шейн|грудн|поясни|шоп|гоп|поп|пкоп|([thтнcсlл]{1,2} ?\d{1,2})|псмт|ддз|хондро|грыж.*диск|радикул|кореш|каудопати|конск.*хвост|плеги|парез|паретическ|тазов.*орган)/i"
```

### Приложение. Процедура анонимизации

Оставить только значения полей ниже, которые расцениваю как не содержащие идентифицирующую личность пациента информацию:

```
submission_id
is_retrieved_by_query
spinality_type_per_query
spinality_type_manual
submission_date
last_modified_date
is_finalized
```

Значения всех остальных полей заменить на `*****`.

## Ручной контроль обновлений по запросу

Добавлена возможность поиска записей по дате поступления, и возможность отбора записей по типу спинальности. Добавлены критерии поиска по спинальному диагнозу, по спинальному осмотру. 

~~Запрос перестал работать: форма открывается, но всегда выдает ноль записей.~~ На поверку сейчас оказалось неправдой и почти наверняка было неправдой и тогда.

Проблема, похоже, в другом: у поступивших за этот период (с 30.01.2019 по 05.02.2019) не было за этот период операций _и_ снимки, которые были сделаны, в Ариадне еще не описаны.

Сейчас попробуем проверить эту гипотезу (посмотреть электронные истории известных пациентов, поступивших за это время), и если это действительно так, то это еще одно мощнейшее обоснование для двух оставшихся (до сих пор не доработанных) критериев включения («типов спинальности»): по тексту осмотров нейрохирургов и травматологов и диагнозу поступления.

## Связь с компьютерным отделом и службой поддержки

PL/SQL-щики сообщают, что в работе. 

## История развития событий

Историю развития событий загрузим позднее.
