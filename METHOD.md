# METHOD.md

## Текущая задача

### Актуальность

См. в других разделах этого файла.

### Цель

Оценить корректность подсчета поступивших за период с 30.01.2019 по 05.02.2019.

Основная гипотеза: (а) запрос выдает меньше поступивших за этот период (с 30.01.2019 по 05.02.2019), чем выявлено при поиске вручную, и (б) причина этого — в том, что не было за этот период спинальных операций у этих пациентов _и_ спинальные КТ или МРТ, которые были сделаны, в Ариадне на момент выполнения запроса еще не описаны.

### Материал

Экспортирую поступивших из Ариадны, и тут их ВНЕЗАПНО (на самом деле, не внезапно) много.

И возникает вопрос: почему выбрал именно эти даты? Почему именно _столько_ дней? Дыра в дизайне.

А ответ простой: об этом просто не подумали. Какой взяли интервал на рутинной проверке запроса, такой и остался. Надо думать в таких вещах…

Итого получилось 1359 историй. Выгружали по каждому дню сначала из АКО, затем из ПО, начиная с 30.01.2019 00:00, сортировка по возрастанию даты поступления.

Запустил запрос по дате поступления с 30.01.2019 по 04.02.2019. Вернул всего 1 запись.

Форму подготовил: все необходимые поля (см. ниже планирование результатов) заполнил, в том числе в `submission_date` внес для всех записей текущие дату и время.

`ft_form_7.csv` (неанонимизированный) — готов к загрузке в БД FormTools.

Однако с учетом того, что записей — 1359, а запрос из них выдал только 1, просматривать их все вряд ли нужно, и, если релевантные спинальные записи, не выданные запросом, и есть в этой выборки, то можно попробовать их выцепить и понять причины из отсутствия в результатах запроса, взяв меньшее число записей.

Для этого отсортируем записи в случайном порядке (в `submission_id` загрузим 1359 случайных чисел без повторения, которые сейчас возьмем с [RANDOM.ORG](https://random.org) — готово, см. [список из 1359 случайных чисел](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/96b8cb62c7ea1791bd4eb503bd8652a84c18dccb/RANDOM.ORG%20-%20Integer%20Set%20Generator.html)) и затем будем просматривать хотя бы до количества, которое необходимо на уровне значимости ~~0,99~~ 0,01 при мощности 0,9 (это сейчас рассчитаем на ближайшем онлайн-калькуляторе для социологических исследований; только вот для какого статистического теста это будет подсчет? непонятно).

Согласно методу, приведенному на странице [калькулятора размера выборки от Raosoft](http://www.raosoft.com/samplesize.html), и с использованием нижеследующих параметров минимальный размер — следующий (далее копипаста со страницы сайта):

```
What margin of error can you accept?
5% is a common choice

1
%
The margin of error is the amount of error that you can tolerate. If 90% of respondents answer yes, while 10% answer no, you may be able to tolerate a larger amount of error than if the respondents are split 50-50 or 45-55. 
Lower margin of error requires a larger sample size.
What confidence level do you need?
Typical choices are 90%, 95%, or 99%


99
%
The confidence level is the amount of uncertainty you can tolerate. Suppose that you have 20 yes-no questions in your survey. With a confidence level of 95%, you would expect that for one of the questions (1 in 20), the percentage of people who answer yes would be more than the margin of error away from the true answer. The true answer is the percentage you would get if you exhaustively interviewed everyone. 
Higher confidence level requires a larger sample size.
What is the population size?
If you don't know, use 20000

1359
How many people are there to choose your random sample from? The sample size doesn't change much for populations larger than 20,000.
What is the response distribution?
Leave this as 50%

0.0736
%
For each question, what do you expect the results will be? If the sample is skewed highly one way or the other,the population probably is, too. If you don't know, use 50%, which gives the largest sample size. See below under More information if this is confusing.
Your recommended sample size is	
48
This is the minimum recommended size of your survey. If you create a sample of this many people and get responses from everyone, you're more likely to get a correct answer than you would from a large sample where only a small percentage of the sample responds to your survey.
```

Итак, нужно просмотреть хотя бы 48 историй.

0.0736 получили как 1 / 1359 (т. к., если верить нашему запросу, среди 1359 записей должна быть только 1 спинальная; мы же хотим показать, что это не так).

Итак, возьмем первые 48 (случайных уже на данный момент) записей из 1359 и загрузим их в БД.

Полную версию файла тоже на всякий случай загрузим в БД, но в отдельную таблицу.

Подготовил и загрузил сокращенную и полную версии в БД FormTools.

Формы готовы к заполнению для обоих заполняющих.

### Результаты

Завершила тест 48 случайных историй, потребовалось 63 минуты. 5 историй прошли по какой-либо из типов спинальности.

Завершил тест 48 случайных историй. Время выполнения: с 2019-02-11 13:36 по 2019-02-11 14:27, но 8 записей уже заполнил ранее, а также отвлекался. Не знаю, сколько историй прошли по какому-либо из типов спинальности: надо смотреть.

```
Percent overall agreement = 87.50%

Free-marginal kappa = 0.84
95% CI for free-marginal kappa [0.73, 0.96]

Fixed-marginal kappa = 0.52
95% CI for fixed-marginal kappa [0.05, 1.00]

# of Cases: 48    # of Categories: 5    # of Raters: 2
```

Закрыл формы для редактирования для обоих участников.

### Обсуждение

Мозговые орехи:

1. Стоит ли добавить рентген позвоночника? Из опыта дежурства в ПО, многие спинальные пациенты поступают с подозрением на перелом. Им выполняют рентген, исключают диагноз и выписывают, не выполняя КТ или МРТ. Дело в том, что обычно это единственный диагноз, а значит, пациент исключительно спинальный. А с другой стороны, нет перелома - нет диагноза. У меня дилемма.

> Я склонялся и склоняюсь к тому, что не нужен, потому что по рентгену не закодировать по AO. Хотя это спорно, согласен.

2. Может, добавить в регулярные выражения вообще ДДЗП? Решили с [ПВЖ](https://github.com/pussiatoday) пополнить регвыр различными вариантами спинальной патологии.

> Будет потом (когда будем заявку PL/SQL-щикам писать, к примеру; там ведь надо будет все пожелания за один раз подать) повод еще раз просмотреть регвыр и убедиться, что все необходимые фрагменты, касающие нозологии по позвоночнику, мы туда включили.

### Планирование: методы

* Поднять электронные истории всех поступивших через приемное или АКО с 30.01.2019 00:00 по 04.02.2019 23:59.
* Извлечь списки в файлы.
* Перенести из этих файлов в [CSV-экспорт из созданной в FormTools формы](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/340a619cecc202ed2b207073d1ab1f39a1551da2/ft_form_7.csv).
* Выполнить запрос по дате поступления с 30.01.2019 по 04.02.2019 и извлечь поступивших и их типы спинальности в файл.
* Заполнить на основании этого файла поля формы, касающиеся запроса.
* Загрузить этот файл в базу данных FormTools.
* Провести процедуру анонимизации (см. [приложение по анонимизации](#приложение-процедура-анонимизации)) и загрузить этот файл сюда, обновив файл [ft_form_7.csv](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/master/ft_form_7.csv).
* Участники из личных аккаунтов получат доступ к веб-интерфейсу формы и дозаполнят недостающие поля: будут вручную открывать каждую историю и оценивать ее «тип спинальности» в соответствии с ранее разработанным алгоритмом (см. [приложение по алгоритму](#приложение-алгоритм-определения-типа-спинальности)).
* При этом в форме все вопросы имеют закрытый характер и имеют опцию «не выбрано» (вид формы см. ниже в разделе о планировании результатов), а также в форме нельзя добавить или удалить запись — можно только просмотреть все списком либо переключить на предыдущую или следующую.
* Ручной просмотр историй и сопоставление по критериям с заполнением таблиц будем выполнять независимо двумя людьми.
* По завершении заполнения — анонимизировать (см. [приложение по анонимизации](#приложение-процедура-анонимизации)) и экспортировать сюда, обновив файл [ft_form_7.csv](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/master/ft_form_7.csv).
* Отвергнуть или принять основную гипотезу.
* Рассчитать показатели согласия между участниками в плане определения типа ([Online Kappa Calculator, Randolph J. J., 2008](http://justusrandolph.net/kappa/)).
* Вынести заключение о корректности или некорректности определения типа запросом в соответствии с алгоритмом (на данной выборке будет не сделать, т. к. мало будет результатов в выдаче запроса).

### Планирование: результаты

Создал форму в [FormTools](https://formtools.org) в режиме внутреннего пользования (т. е. форма доступна только из личного аккаунта участника).

Копипаста формы для каждого из заполняющих выглядит таким образом, при этом редактируемы только поля «Тип спинальности вручную» (можно выбрать тип, используя переключатель) и «Примечание» (до 2000 символов):

```
Путь поступления	
Дата и время поступления	
UPI (компьютерный номер)	
MRN (номер истории)	
Тип спинальности вручную	 Не выбрано 
 Спинальная операция 
 Спинальная КТ или МРТ 
 Спинальный осмотр 
 Спинальный диагноз поступления 
 Не спинальный диагноз поступления 
Примечание	
```

Сама FormTools хранит данные в отдельной таблице БД.

Всего в ней 15 полей (см. [экспорт из FormTools](https://github.com/p1m-ortho/xs-led-dzhanelidze-global-spine-query/blob/340a619cecc202ed2b207073d1ab1f39a1551da2/ft_form_7.csv); здесь и ниже CSV получены путем SQL SELECT из БД FormTools):

Из них 1 поле (`is_finalized`) — служебное, содержит значение `yes`, если форма подана, или `no`, если форма начата и заполнена, но еще не подана.

4 поля заполняются программой автоматически при подаче и изменении записи и содержат ее характеристики («Свидание» — кривой перевод для «Подано»):

```
data_type,field_title,col_name
number,ID,submission_id
date,Свидание,submission_date
date,Изменен,last_modified_date
number,IP-адрес,ip_address
```

4 поля заполним путем перенесения данных из списков поступивших:

```
data_type,field_title,col_name
string,Путь поступления,admission_mode
string,Дата и время поступления,admission_timestamp
string,UPI (компьютерный номер),upi
string,MRN (номер истории),mrn
```

2 поля заполним путем перенесения данных из результатов запроса:

```
data_type,field_title,col_name
string,Наличие в результатах запроса,is_retrieved_by_query
string,Тип спинальности по запросу,spinality_type_per_query
```

2 поля заполнит вручную один заполняющий:

```
data_type,field_title,col_name
string,Тип спинальности вручную,spinality_type_manual_1
string,Примечание,comment_1
```

2 поля заполнит вручную второй заполняющий:

```
data_type,field_title,col_name
string,Тип спинальности вручную,spinality_type_manual_2
string,Примечание,comment_2
```

Итого 15 полей.

### Приложение. Алгоритм определения типа спинальности

* Если за время госпитализации выполнялась хотя бы одна хирургическая операция, то если хотя бы одна из этих операций по коду соответствует одному из кодов, перечисленных в [приложении по кодам](#приложение-коды-спинальных-операций) (список внутренних кодов, применяемых в НИИ СП для кодирования спинальных операций; загрузим позднее), то включить в выборку (назовем этот критерий "Спинальная операция").
* Если не "Спинальная операция", но выполнялась хотя бы одна МРТ или КТ, то если в описании хотя бы одной из этих КТ или МРТ есть совпадение по маске "позвон", то включить в выборку ("Спинальная КТ или МРТ").
* Если не "Спинальная КТ или МРТ", то если был хотя бы один осмотр травматолога или нейрохирурга, то если в поле "Заключение" хотя бы одного из этих осмотров есть совпадение по регулярному выражению (см. [приложение по регулярному выражению](#приложение-регулярное-выражение--критерий-для-типов-спинальный-осмотр-и-спинальный-диагноз-поступления)), то включить в выборку ("Спинальный осмотр").
* Если не "Спинальный осмотр", то если в поле "Диагноз поступления" в "Протоколе регистратора" есть совпадение по регулярному выражению (см. [приложение по регулярному выражению](#приложение-регулярное-выражение--критерий-для-типов-спинальный-осмотр-и-спинальный-диагноз-поступления)), то включить в выборку ("Спинальный диагноз поступления").
* Если не подходит по "Спинальный диагноз поступления", то "Не спинальный диагноз поступления".

> Обратили внимание, что маски «позвон» вообще-то может быть и не достаточно для выявления всех релевантных описаний КТ и МРТ. Потом учтем, обдумаем.

> А поля «Заключение»-то нет во многих осмотрах! Эх вы. Не будет этот критерий работать.

### Приложение. Регулярное выражение — критерий для типов «Спинальный осмотр» и «Спинальный диагноз поступления»

```
/(позвон|спондил|спин|вертебр|шейн|грудн|поясни|шоп|гоп|поп|пкоп|([thтнcсlл]{1,2} ?\d{1,2})|псмт|ддз|хондро|грыж.*диск|радикул|кореш|каудопати|конск.*хвост|плеги|парез|паретическ|тазов.*орган)/i
```

> Обратили внимание, что в запросе совсем не упомянуты термины из серии спинальных вмешательств (например ТПФ). Нужно будет доработать.

### Приложение. Процедура анонимизации

Оставить только значения полей ниже, которые расцениваю как не содержащие идентифицирующую личность пациента информацию:

```
submission_id
is_retrieved_by_query
spinality_type_per_query
spinality_type_manual_1
spinality_type_manual_2
comment_1
comment_2
submission_date
last_modified_date
is_finalized
```

Значения всех остальных полей заменить на `*****`.

### Приложение. Коды спинальных операций

```
ВтмпНейр01
ВтмпНейр02
ВтмпНейро66
ВтмпОрто01
ВтмпОрто02
НейрСпинМозг1
НейрСпинМозг10
НейрСпинМозг11
НейрСпинМозг12
НейрСпинМозг13
НейрСпинМозг14
НейрСпинМозг2
НейрСпинМозг3
НейрСпинМозг4
НейрСпинМозг5
НейрСпинМозг6
НейрСпинМозг7
НейрСпинМозг8
НейрСпинМозг9
ТравмПозв1
ТравмПозв10
ТравмПозв11
ТравмПозв12
ТравмПозв13
ТравмПозв14
ТравмПозв2
ТравмПозв3
ТравмПозв4
ТравмПозв5
ТравмПозв8
ТравмПозв9
```

## Ручной контроль обновлений по запросу

Добавлена возможность поиска записей по дате поступления, и возможность отбора записей по типу спинальности. Добавлены критерии поиска по спинальному диагнозу, по спинальному осмотру. 

~~Запрос перестал работать: форма открывается, но всегда выдает ноль записей.~~ На поверку сейчас оказалось неправдой и почти наверняка было неправдой и тогда.

Проблема, похоже, в другом: у поступивших за этот период (с 30.01.2019 по 05.02.2019) не было за этот период операций _и_ снимки, которые были сделаны, в Ариадне еще не описаны.

Сейчас попробуем проверить эту гипотезу (посмотреть электронные истории известных пациентов, поступивших за это время), и если это действительно так, то это еще одно мощнейшее обоснование для двух оставшихся (до сих пор не доработанных) критериев включения («типов спинальности»): по тексту осмотров нейрохирургов и травматологов и диагнозу поступления.

Только что выполнили запрос без каких-либо ограничений, кроме `Спинальный осмотр, Спинальный диагноз поступления`. Запрос не вернул ни одной записи, что свидетельствует о том, что эти типы спинальности до сих пор находятся в разработке.

## Связь с компьютерным отделом и службой поддержки

PL/SQL-щики сообщают, что в работе. 

Только что компьютерный отдел сообщил, что поступили новые вопросы от PL/SQL-звена. Изучим.

## История развития событий

Историю развития событий загрузим позднее.
